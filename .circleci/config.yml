version: 2
jobs:
  build-amazon:
    working_directory: ~/build
    docker:
      - image: syginc/lambda-builder:node8

    steps:
      - checkout

      - run: yum install -y libtool-ltdl-devel

      - run: scripts/build.sh

      - run: scripts/create-release.sh syginc imagemagick-convert $(cat release-version) convert-amazonlinux201703 dist/convert

      - store_artifacts:
          path: dist/

      - persist_to_workspace:
          root: .
          paths:
            - dist

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build-amazon:
          filters:
            tags:
              only: /v[0-9]+(\.[0-9]+)*/